<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Layered SVG Export • Bootstrap UI (Road classes)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- MapLibre -->
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>

    <style>
        html, body {
            height: 100%
        }

        body {
            margin: 0
        }

        #map {
            position: relative;
            height: calc(100% - 56px - 40px)
        }

        /* nav + footer heights */
        #mapCanvas {
            position: absolute;
            inset: 0
        }

        .control-card {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            width: 460px;
            max-height: calc(88vh - 40px);
            overflow: auto
        }

        .suggest-wrap {
            position: relative
        }

        .suggest-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1100;
            display: none;
            max-height: 280px;
            overflow: auto
        }

        .handle {
            width: 12px;
            height: 12px;
            background: #111;
            border: 2px solid #fff;
            border-radius: 2px
        }

        .handle.se {
            cursor: se-resize
        }

        .handle.nw {
            cursor: nw-resize
        }

        .handle.mid {
            width: 10px;
            height: 10px;
            background: #fff;
            border: 2px solid #111;
            border-radius: 50%;
            cursor: move
        }

        .attrib {
            position: absolute;
            right: .75rem;
            bottom: .75rem;
            z-index: 600;
            background: rgba(255, 255, 255, .9);
            padding: .2rem .5rem;
            border-radius: .25rem;
            font-size: .875rem
        }

        .color {
            width: 42px;
            height: 36px;
            padding: 0
        }

        .modal-xxl {
            --bs-modal-width: min(1200px, 95vw)
        }

        .svg-scroll {
            max-height: 80vh;
            overflow: auto;
            background: #fff;
            display: flex;
            justify-content: center
        }

        .svg-wrap {
            padding: 16px
        }

        /* Full-page busy overlay used for Export */
        .page-busy {
            position: fixed;
            inset: 56px 0 40px 0; /* under navbar, above footer */
            background: rgba(255, 255, 255, .75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        /* Sticky footer */
        .app-footer {
            height: 40px;
            line-height: 40px;
            font-size: .9rem
        }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h6">Layered SVG Export</span>
        <div class="d-flex gap-2">
            <button id="btnPreview" class="btn btn-outline-light btn-sm">Preview</button>
            <button id="btnExport" class="btn btn-success btn-sm">Export</button>
        </div>
    </div>
</nav>

<!-- Busy overlay for Export -->
<div id="pageBusy" class="page-busy d-none">
    <div class="text-center">
        <div class="spinner-border text-success mb-2" role="status" aria-hidden="true"></div>
        <div class="text-dark fw-semibold">Building vector…</div>
    </div>
</div>

<div id="map">
    <div id="mapCanvas"></div>

    <div class="card control-card shadow">
        <div class="card-header py-2">
            <div class="h6 mb-0">Controls</div>
        </div>
        <div class="card-body">

            <!-- Search -->
            <div class="mb-3">
                <label class="form-label mb-1">Search city/location</label>
                <div class="input-group suggest-wrap">
                    <input id="search" class="form-control" type="text" placeholder="Start typing…" autocomplete="off">
                    <button id="btnSearch" class="btn btn-primary">Find</button>
                    <div id="suggest" class="dropdown-menu suggest-menu"></div>
                </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-2 mb-3">
                <button id="btnToggleFrame" class="btn btn-warning">Add/Remove frame</button>
                <span class="text-muted small ms-auto">Data: OSM via Overpass</span>
            </div>

            <!-- Options -->
            <div class="mb-3">
                <div class="form-text mb-2">Include and color</div>

                <!-- Highways, split by class -->
                <div class="border rounded p-2 mb-2">
                    <div class="small text-muted mb-2">Road classes</div>

                    <div class="row g-2 align-items-center mb-2">
                        <div class="col-7">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkMotorway" checked>
                                <label class="form-check-label" for="chkMotorway">motorway</label>
                            </div>
                        </div>
                        <div class="col-5 text-end">
                            <!-- default red -->
                            <input id="colMotorway" class="form-control form-control-color color" type="color"
                                   value="#ff0000" title="Motorway color">
                        </div>
                    </div>

                    <div class="row g-2 align-items-center mb-2">
                        <div class="col-7">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkTrunk" checked>
                                <label class="form-check-label" for="chkTrunk">trunk</label>
                            </div>
                        </div>
                        <div class="col-5 text-end">
                            <input id="colTrunk" class="form-control form-control-color color" type="color"
                                   value="#ff7f00" title="Trunk color">
                        </div>
                    </div>

                    <div class="row g-2 align-items-center mb-2">
                        <div class="col-7">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkPrimary" checked>
                                <label class="form-check-label" for="chkPrimary">primary</label>
                            </div>
                        </div>
                        <div class="col-5 text-end">
                            <input id="colPrimary" class="form-control form-control-color color" type="color"
                                   value="#ffd000" title="Primary color">
                        </div>
                    </div>

                    <div class="row g-2 align-items-center mb-2">
                        <div class="col-7">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkSecondary" checked>
                                <label class="form-check-label" for="chkSecondary">secondary</label>
                            </div>
                        </div>
                        <div class="col-5 text-end">
                            <input id="colSecondary" class="form-control form-control-color color" type="color"
                                   value="#999999" title="Secondary color">
                        </div>
                    </div>

                    <div class="row g-2 align-items-center mb-2">
                        <div class="col-7">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkTertiary" checked>
                                <label class="form-check-label" for="chkTertiary">tertiary</label>
                            </div>
                        </div>
                        <div class="col-5 text-end">
                            <input id="colTertiary" class="form-control form-control-color color" type="color"
                                   value="#bbbbbb" title="Tertiary color">
                        </div>
                    </div>

                    <div class="row g-2 align-items-center">
                        <div class="col-7">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chkLocal" checked>
                                <label class="form-check-label" for="chkLocal">local (residential, unclassified,
                                    service, living_street)</label>
                            </div>
                        </div>
                        <div class="col-5 text-end">
                            <input id="colLocal" class="form-control form-control-color color" type="color"
                                   value="#333333" title="Local roads color">
                        </div>
                    </div>
                </div>

                <!-- Non-road layers -->
                <div class="row g-2 align-items-center mt-2">
                    <div class="col-7">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="chkBuildings" checked>
                            <label class="form-check-label" for="chkBuildings">Buildings</label>
                        </div>
                    </div>
                    <div class="col-5 text-end">
                        <input id="colBuildings"
                               class="form-control form-control-color color"
                               type="color"
                               value="#bbbbbb"
                               title="Buildings color">
                    </div>
                </div>

                <div class="row g-2 align-items-center mb-2">
                    <div class="col-7">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="chkWater" checked>
                            <label class="form-check-label" for="chkWater">Water</label>
                        </div>
                    </div>
                    <div class="col-5 text-end">
                        <input id="colWater" class="form-control form-control-color color" type="color" value="#4b64e1"
                               title="Water color">
                    </div>
                </div>

                <div class="row g-2 align-items-center">
                    <div class="col-7">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="chkParks" checked>
                            <label class="form-check-label" for="chkParks">Parks/grass</label>
                        </div>
                    </div>
                    <div class="col-5 text-end">
                        <input id="colParks" class="form-control form-control-color color" type="color" value="#00ff32"
                               title="Parks color">
                    </div>
                </div>
            </div>

            <!-- Export size -->
            <div class="row g-2">
                <div class="col-6">
                    <label for="w" class="form-label mb-1">SVG width (px)</label>
                    <input id="w" type="number" min="512" step="128" value="4096" class="form-control">
                </div>
                <div class="col-6">
                    <label for="h" class="form-label mb-1">SVG height (px)</label>
                    <input id="h" type="number" min="512" step="128" value="4096" class="form-control">
                </div>
            </div>

        </div>
    </div>

    <div class="attrib">© OpenStreetMap contributors</div>
</div>

<!-- Modal for vector preview (kept for Preview only) -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xxl">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Vector Preview</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewBusy" class="d-flex align-items-center justify-content-center py-5">
                    <div class="spinner-border me-2" role="status" aria-hidden="true"></div>
                    <span class="text-muted">Generating SVG…</span>
                </div>
                <div id="previewSvg" class="svg-scroll d-none">
                    <div id="previewSvgWrap" class="svg-wrap"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnDownloadModal" class="btn btn-success" disabled>Download SVG</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Sticky footer -->
<footer class="app-footer bg-light text-center fixed-bottom border-top">
    <span id="footerDate"></span>
    <span class="mx-2">·</span>
    <span>made by <a href="https://kutsyk.github.io/" target="_blank" rel="noopener">kutsyk</a></span>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
    /* ==================== FOOTER DATE ==================== */
    (function () {
        const el = document.getElementById('footerDate');
        const d = new Date();
        const pad = n => String(n).padStart(2, '0');
        el.textContent = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    })();

    /* ==================== MAP ==================== */
    const map = new maplibregl.Map({
        container: 'mapCanvas',
        style: {
            version: 8,
            sources: {
                osm: {
                    type: 'raster',
                    tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '© OpenStreetMap contributors'
                }
            },
            layers: [{id: 'osm-tiles', type: 'raster', source: 'osm'}]
        },
        center: [0, 20], zoom: 2
    });

    /* ==================== SEARCH WITH PROPOSALS ==================== */
    const searchEl = document.getElementById('search');
    const suggestEl = document.getElementById('suggest');
    let suggestItems = [], activeIndex = -1, debounceId = null;

    function clearSuggest() {
        suggestEl.innerHTML = '';
        suggestEl.classList.remove('show');
        suggestItems = [];
        activeIndex = -1;
    }

    function renderSuggest(results) {
        suggestEl.innerHTML = '';
        results.forEach((r, i) => {
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.role = 'option';
            a.dataset.index = String(i);
            a.textContent = r.display_name;
            a.addEventListener('mousedown', (e) => {
                e.preventDefault();
                selectResult(i);
            });
            suggestEl.appendChild(a);
        });
        suggestItems = results;
        if (results.length) suggestEl.classList.add('show'); else clearSuggest();
    }

    async function fetchSuggest(q) {
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=8&addressdetails=0`;
        const res = await fetch(url, {headers: {'Accept': 'application/json'}});
        if (!res.ok) return [];
        return res.json();
    }

    function selectResult(i) {
        const d = suggestItems[i];
        if (!d) return;
        searchEl.value = d.display_name;
        clearSuggest();
        if (d.boundingbox) {
            const south = +d.boundingbox[0], north = +d.boundingbox[1], west = +d.boundingbox[2],
                east = +d.boundingbox[3];
            map.fitBounds([[west, south], [east, north]], {padding: 60, duration: 600});
        } else if (d.lat && d.lon) {
            map.flyTo({center: [+d.lon, +d.lat], zoom: 11, speed: 0.6});
        }
    }

    searchEl.addEventListener('input', () => {
        const q = searchEl.value.trim();
        if (!q) {
            clearSuggest();
            return;
        }
        clearTimeout(debounceId);
        debounceId = setTimeout(async () => renderSuggest(await fetchSuggest(q)), 250);
    });
    searchEl.addEventListener('keydown', (e) => {
        const c = suggestItems.length;
        if (!c) return;
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = (activeIndex + 1) % c;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = (activeIndex - 1 + c) % c;
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIndex >= 0) selectResult(activeIndex);
        } else if (e.key === 'Escape') {
            clearSuggest();
        }
    });
    document.addEventListener('click', e => {
        if (!e.target.closest('.suggest-wrap')) clearSuggest();
    });
    document.getElementById('btnSearch').addEventListener('click', async () => {
        const q = searchEl.value.trim();
        if (!q) return;
        const data = await fetchSuggest(q);
        if (data && data.length) selectResult(0);
    });

    /* ==================== FRAME ==================== */
    let frame = null, handleNW = null, handleSE = null, handleMID = null;
    const elNW = document.createElement('div');
    elNW.className = 'handle nw';
    const elSE = document.createElement('div');
    elSE.className = 'handle se';
    const elMID = document.createElement('div');
    elMID.className = 'handle mid';

    function addFrame() {
        const b = map.getBounds();
        const padLng = (b.getEast() - b.getWest()) * 0.15;
        const padLat = (b.getNorth() - b.getSouth()) * 0.15;
        frame = {nw: [b.getWest() + padLng, b.getNorth() - padLat], se: [b.getEast() - padLng, b.getSouth() + padLat]};
        drawFrame();
    }

    function removeFrame() {
        frame = null;
        if (map.getLayer('frame-line')) map.removeLayer('frame-line');
        if (map.getSource('frame-src')) map.removeSource('frame-src');
        if (handleNW) {
            handleNW.remove();
            handleNW = null;
        }
        if (handleSE) {
            handleSE.remove();
            handleSE = null;
        }
        if (handleMID) {
            handleMID.remove();
            handleMID = null;
        }
    }

    function midOf(a, b) {
        return {lng: (a[0] + b[0]) / 2, lat: (a[1] + b[1]) / 2};
    }

    function clamp(ll) {
        return [ll.lng, ll.lat];
    }

    function drawFrame() {
        if (!frame) return;
        const coords = [frame.nw, [frame.se[0], frame.nw[1]], frame.se, [frame.nw[0], frame.se[1]], frame.nw];
        const data = {
            type: 'FeatureCollection',
            features: [{type: 'Feature', geometry: {type: 'LineString', coordinates: coords}}]
        };
        if (!map.getSource('frame-src')) {
            map.addSource('frame-src', {type: 'geojson', data});
            map.addLayer({
                id: 'frame-line', type: 'line', source: 'frame-src',
                paint: {'line-color': '#ff6d00', 'line-width': 2.5, 'line-dasharray': [2, 2]}
            });
        } else {
            map.getSource('frame-src').setData(data);
        }

        if (!handleNW) {
            handleNW = new maplibregl.Marker({element: elNW, draggable: true}).setLngLat(frame.nw).addTo(map);
            handleSE = new maplibregl.Marker({element: elSE, draggable: true}).setLngLat(frame.se).addTo(map);
            handleMID = new maplibregl.Marker({
                element: elMID,
                draggable: true
            }).setLngLat(midOf(frame.nw, frame.se)).addTo(map);

            handleNW.on('drag', () => {
                frame.nw = clamp(handleNW.getLngLat());
                drawFrame();
            });
            handleSE.on('drag', () => {
                frame.se = clamp(handleSE.getLngLat());
                drawFrame();
            });
            handleMID.on('drag', () => {
                const mid = clamp(handleMID.getLngLat());
                const dx = mid[0] - (frame.nw[0] + frame.se[0]) / 2;
                const dy = mid[1] - (frame.nw[1] + frame.se[1]) / 2;
                frame.nw = [frame.nw[0] + dx, frame.nw[1] + dy];
                frame.se = [frame.se[0] + dx, frame.se[1] + dy];
                handleNW.setLngLat(frame.nw);
                handleSE.setLngLat(frame.se);
                handleMID.setLngLat(midOf(frame.nw, frame.se));
                drawFrame();
            });
        } else {
            handleNW.setLngLat(frame.nw);
            handleSE.setLngLat(frame.se);
            handleMID.setLngLat(midOf(frame.nw, frame.se));
        }
    }

    document.getElementById('btnToggleFrame').addEventListener('click', () => {
        if (frame) removeFrame(); else addFrame();
    });
    map.on('move', () => {
        if (frame) drawFrame();
    });

    function getActiveBBox() {
        if (!frame) return map.getBounds();
        const west = Math.min(frame.nw[0], frame.se[0]), east = Math.max(frame.nw[0], frame.se[0]);
        const south = Math.min(frame.se[1], frame.nw[1]), north = Math.max(frame.se[1], frame.nw[1]);
        return {getWest: () => west, getEast: () => east, getSouth: () => south, getNorth: () => north};
    }

    /* ==================== OPTIONS ==================== */
    function getSelections() {
        return {
            width: Math.max(512, (+document.getElementById('w').value | 0) || 4096),
            height: Math.max(512, (+document.getElementById('h').value | 0) || 4096),

            // road classes
            want: {
                motorway: document.getElementById('chkMotorway').checked,
                trunk: document.getElementById('chkTrunk').checked,
                primary: document.getElementById('chkPrimary').checked,
                secondary: document.getElementById('chkSecondary').checked,
                tertiary: document.getElementById('chkTertiary').checked,
                local: document.getElementById('chkLocal').checked,
                water: document.getElementById('chkWater').checked,
                parks: document.getElementById('chkParks').checked,
                buildings: document.getElementById('chkBuildings').checked
            },
            colors: {
                motorway: document.getElementById('colMotorway').value || '#dd00ff',  // default red
                trunk: document.getElementById('colTrunk').value || '#ff7f00',
                primary: document.getElementById('colPrimary').value || '#ffd000',
                secondary: document.getElementById('colSecondary').value || '#00ffcf',
                tertiary: document.getElementById('colTertiary').value || '#bbbbbb',
                local: document.getElementById('colLocal').value || '#333333',
                water: document.getElementById('colWater').value || '#4b64e1',
                parks: document.getElementById('colParks').value || '#00ff32',
                buildings: document.getElementById('colBuildings').value || '#fd0000'
            }
        };
    }

    /* ==================== OVERPASS & PREDICATES ==================== */
    function buildOverpassBBox(b, want) {
        const west = b.getWest(), south = b.getSouth(), east = b.getEast(), north = b.getNorth();
        const parts = [];
        if (want.parks) parts.push(
            `way["leisure"="park"](${south},${west},${north},${east});`,
            `relation["leisure"="park"](${south},${west},${north},${east});`,
            `way["landuse"="grass"](${south},${west},${north},${east});`,
            `relation["landuse"="grass"](${south},${west},${north},${east});`,
            `way["landuse"="recreation_ground"](${south},${west},${north},${east});`,
            `relation["landuse"="recreation_ground"](${south},${west},${north},${east});`
        );
        if (want.water) parts.push(
            `way["natural"="water"](${south},${west},${north},${east});`,
            `relation["natural"="water"](${south},${west},${north},${east});`,
            `way["waterway"="riverbank"](${south},${west},${north},${east});`,
            `relation["waterway"="riverbank"](${south},${west},${north},${east});`,
            `way["waterway"~"^(river|stream|canal)$"](${south},${west},${north},${east});`
        );

        if (want.buildings) parts.push(
            `way["building"](${south},${west},${north},${east});`,
            `relation["building"](${south},${west},${north},${east});`
        );

        // One catch-all for roads; classification is done client-side
        if (want.motorway || want.trunk || want.primary || want.secondary || want.tertiary || want.local)
            parts.push(`way["highway"](${south},${west},${north},${east});`);

        const body = parts.join('\n  ');
        return `
[out:json][timeout:180];
(
  ${body}
);
out body geom;`;
    }

    const isPark = t => t && (t.leisure === 'park' || t.landuse === 'grass' || t.landuse === 'recreation_ground');
    const isWaterPlg = t => t && (t.natural === 'water' || t.waterway === 'riverbank');
    const isWaterLin = t => t && /^(river|stream|canal)$/.test(t.waterway || '');
    const hwyEq = (t, val) => t && t.highway === val;
    const isLocalRoad = t => t && /^(residential|unclassified|service|living_street)$/.test(t.highway || '');
    const isBuilding  = t => t && !!t.building;

    async function fetchElementsForBBox(bbox, want) {
        const ovp = buildOverpassBBox(bbox, want);
        const resp = await fetch('https://overpass-api.de/api/interpreter', {
            method: 'POST', headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'},
            body: 'data=' + encodeURIComponent(ovp)
        });
        if (!resp.ok) throw new Error('Overpass error');
        const elements = (await resp.json()).elements || [];
        return elements;
    }

    /* ==================== GEOMETRY & SVG ==================== */
    const R = 6378137;
    const lon2x = lon => R * lon * Math.PI / 180;
    const lat2y = lat => {
        const r = lat * Math.PI / 180;
        return R * Math.log(Math.tan(Math.PI / 4 + r / 2));
    };

    function buildProjectors(bbox, width, height, pad = 24) {
        const west = bbox.getWest(), south = bbox.getSouth(), east = bbox.getEast(), north = bbox.getNorth();
        const minX = Math.min(lon2x(west), lon2x(east)), maxX = Math.max(lon2x(west), lon2x(east));
        const minY = Math.min(lat2y(south), lat2y(north)), maxY = Math.max(lat2y(south), lat2y(north));
        const innerW = width - pad * 2, innerH = height - pad * 2;
        const scale = Math.min(innerW / (maxX - minX), innerH / (maxY - minY));
        const tx = X => pad + (X - minX) * scale;
        const ty = Y => pad + (maxY - Y) * scale;
        return {tx, ty, pad, innerW, innerH, west, south, east, north};
    }

    function lineString(coords, tx, ty) {
        if (!coords || !coords.length) return '';
        let d = '';
        for (let i = 0; i < coords.length; i++) {
            const c = coords[i];
            const X = tx(lon2x(c.lon)), Y = ty(lat2y(c.lat));
            d += (i === 0 ? `M${X.toFixed(2)},${Y.toFixed(2)}` : `L${X.toFixed(2)},${Y.toFixed(2)}`);
        }
        return d;
    }

    function polygonPath(geom, tx, ty) {
        if (!geom || !geom.length) return '';
        const first = geom[0], last = geom[geom.length - 1];
        let d = lineString(geom, tx, ty);
        if (first && last && first.lat === last.lat && first.lon === last.lon) d += 'Z';
        return d;
    }

    function buildSVG({width, height, bbox, elements, want, colors}) {
        const {tx, ty, pad, innerW, innerH, west, south, east, north} = buildProjectors(bbox, width, height, 24);
        const SVG_NS = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(SVG_NS, 'svg');
        svg.setAttribute('xmlns', SVG_NS);
        svg.setAttribute('width', width);
        svg.setAttribute('height', height);
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

        const bg = document.createElementNS(SVG_NS, 'rect');
        bg.setAttribute('x', '0');
        bg.setAttribute('y', '0');
        bg.setAttribute('width', width);
        bg.setAttribute('height', height);
        bg.setAttribute('fill', '#ffffff');
        svg.appendChild(bg);

        if (frame) {
            const defs = document.createElementNS(SVG_NS, 'defs');
            const clip = document.createElementNS(SVG_NS, 'clipPath');
            clip.setAttribute('id', 'clip');
            const rect = document.createElementNS(SVG_NS, 'rect');
            rect.setAttribute('x', pad);
            rect.setAttribute('y', pad);
            rect.setAttribute('width', innerW);
            rect.setAttribute('height', innerH);
            clip.appendChild(rect);
            defs.appendChild(clip);
            svg.appendChild(defs);
        }
        const group = () => {
            const g = document.createElementNS(SVG_NS, 'g');
            if (frame) g.setAttribute('clip-path', 'url(#clip)');
            return g;
        };

        const gParks = group();
        gParks.setAttribute('id', 'parks');
        const gWater = group();
        gWater.setAttribute('id', 'water');
        const gBldg =group();
        gBldg .setAttribute('id','buildings');

        const gMotor = group();
        gMotor.setAttribute('id', 'motorway');
        const gTrunk = group();
        gTrunk.setAttribute('id', 'trunk');
        const gPrim = group();
        gPrim.setAttribute('id', 'primary');
        const gSec = group();
        gSec.setAttribute('id', 'secondary');
        const gTert = group();
        gTert.setAttribute('id', 'tertiary');
        const gLocal = group();
        gLocal.setAttribute('id', 'local');

        // Prepare feature buckets
        const parks = want.parks ? elements.filter(e => isPark(e.tags)) : [];
        const watersP = want.water ? elements.filter(e => isWaterPlg(e.tags)) : [];
        const watersL = want.water ? elements.filter(e => isWaterLin(e.tags)) : [];
        const buildings = want.buildings ? elements.filter(e=>isBuilding(e.tags))     : [];

        const ways = elements.filter(e => e.type === 'way' && e.geometry && e.geometry.length >= 2);
        const mtr = want.motorway ? ways.filter(e => hwyEq(e.tags, 'motorway')) : [];
        const trk = want.trunk ? ways.filter(e => hwyEq(e.tags, 'trunk')) : [];
        const pry = want.primary ? ways.filter(e => hwyEq(e.tags, 'primary')) : [];
        const sec = want.secondary ? ways.filter(e => hwyEq(e.tags, 'secondary')) : [];
        const ter = want.tertiary ? ways.filter(e => hwyEq(e.tags, 'tertiary')) : [];
        const loc = want.local ? ways.filter(e => isLocalRoad(e.tags)) : [];

        // Parks polygons
        for (const feat of parks) {
            if (feat.type === 'way' && feat.geometry) {
                const p = document.createElementNS(SVG_NS, 'path');
                p.setAttribute('d', polygonPath(feat.geometry, tx, ty));
                p.setAttribute('fill', colors.parks);
                p.setAttribute('stroke', 'none');
                gParks.appendChild(p);
            } else if (feat.type === 'relation' && feat.members) {
                for (const mem of feat.members) {
                    if (!mem.geometry) continue;
                    const p = document.createElementNS(SVG_NS, 'path');
                    p.setAttribute('d', polygonPath(mem.geometry, tx, ty));
                    p.setAttribute('fill', colors.parks);
                    p.setAttribute('stroke', 'none');
                    gParks.appendChild(p);
                }
            }
        }
        // Water polygons
        for (const feat of watersP) {
            if (feat.type === 'way' && feat.geometry) {
                const p = document.createElementNS(SVG_NS, 'path');
                p.setAttribute('d', polygonPath(feat.geometry, tx, ty));
                p.setAttribute('fill', colors.water);
                p.setAttribute('stroke', colors.water);
                p.setAttribute('stroke-width', '0.8');
                gWater.appendChild(p);
            } else if (feat.type === 'relation' && feat.members) {
                for (const mem of feat.members) {
                    if (!mem.geometry) continue;
                    const p = document.createElementNS(SVG_NS, 'path');
                    p.setAttribute('d', polygonPath(mem.geometry, tx, ty));
                    p.setAttribute('fill', colors.water);
                    p.setAttribute('stroke', colors.water);
                    p.setAttribute('stroke-width', '0.8');
                    gWater.appendChild(p);
                }
            }
        }
        // Water lines
        for (const feat of watersL) {
            if (feat.type === 'way' && feat.geometry) {
                const d = lineString(feat.geometry, tx, ty);
                if (!d) continue;
                const p = document.createElementNS(SVG_NS, 'path');
                p.setAttribute('d', d);
                p.setAttribute('fill', 'none');
                p.setAttribute('stroke', colors.water);
                p.setAttribute('stroke-width', '1.2');
                p.setAttribute('stroke-linecap', 'round');
                p.setAttribute('stroke-linejoin', 'round');
                gWater.appendChild(p);
            }
        }

        if (want.buildings) {
            for (const feat of buildings) {
                if (feat.type === 'way' && feat.geometry) {
                    const p = document.createElementNS(SVG_NS,'path');
                    p.setAttribute('d', polygonPath(feat.geometry, tx, ty));
                    p.setAttribute('fill', colors.buildings);
                    p.setAttribute('stroke', '#fd0000');
                    p.setAttribute('stroke-width', '0.4');
                    gBldg.appendChild(p);
                } else if (feat.type === 'relation' && feat.members) {
                    for (const mem of feat.members) {
                        if (!mem.geometry) continue;
                        const p = document.createElementNS(SVG_NS,'path');
                        p.setAttribute('d', polygonPath(mem.geometry, tx, ty));
                        p.setAttribute('fill', colors.buildings);
                        p.setAttribute('stroke', '#fd0000');
                        p.setAttribute('stroke-width', '0.4');
                        gBldg.appendChild(p);
                    }
                }
            }
        }

        // Lines helper
        const addLine = (collection, g, color, strokeWidth) => {
            for (const feat of collection) {
                const d = lineString(feat.geometry, tx, ty);
                if (!d) continue;
                const p = document.createElementNS(SVG_NS, 'path');
                p.setAttribute('d', d);
                p.setAttribute('fill', 'none');
                p.setAttribute('stroke', color);
                p.setAttribute('stroke-linecap', 'round');
                p.setAttribute('stroke-linejoin', 'round');
                p.setAttribute('stroke-width', strokeWidth);
                g.appendChild(p);
            }
        };

        // Draw roads by class (thicker → thinner)
        if (want.motorway) addLine(mtr, gMotor, colors.motorway, 3.2);
        if (want.trunk) addLine(trk, gTrunk, colors.trunk, 3.0);
        if (want.primary) addLine(pry, gPrim, colors.primary, 2.6);
        if (want.secondary) addLine(sec, gSec, colors.secondary, 2.2);
        if (want.tertiary) addLine(ter, gTert, colors.tertiary, 2.0);
        if (want.local) addLine(loc, gLocal, colors.local, 1.6);

        // Layer order: polygons → water lines → big → small
        if (want.parks) svg.appendChild(gParks);
        if (want.water) svg.appendChild(gWater);
        if(want.buildings) svg.appendChild(gBldg);
        if (want.motorway) svg.appendChild(gMotor);
        if (want.trunk) svg.appendChild(gTrunk);
        if (want.primary) svg.appendChild(gPrim);
        if (want.secondary) svg.appendChild(gSec);
        if (want.tertiary) svg.appendChild(gTert);
        if (want.local) svg.appendChild(gLocal);

        const serializer = new XMLSerializer();
        const svgStr = serializer.serializeToString(svg);
        const name = `map_export_${west.toFixed(4)}_${south.toFixed(4)}_${east.toFixed(4)}_${north.toFixed(4)}_${width}x${height}.svg`.replace(/[^\w\.\-]+/g, '_');
        return {svgStr, fileName: name};
    }

    /* ==================== PREVIEW / EXPORT ==================== */
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    const previewBusy = document.getElementById('previewBusy');
    const previewSvg = document.getElementById('previewSvg');
    const previewWrap = document.getElementById('previewSvgWrap');
    const btnDownloadModal = document.getElementById('btnDownloadModal');
    const pageBusy = document.getElementById('pageBusy');

    function openPreviewBusy() {
        btnDownloadModal.disabled = true;
        previewBusy.classList.remove('d-none');
        previewSvg.classList.add('d-none');
        previewWrap.innerHTML = '';
        modal.show();
    }

    function showPreviewSvg(svgStr, fileName) {
        previewWrap.innerHTML = svgStr;
        previewBusy.classList.add('d-none');
        previewSvg.classList.remove('d-none');
        btnDownloadModal.disabled = false;
        btnDownloadModal.onclick = () => downloadSVG(svgStr, fileName);
    }

    function downloadSVG(svgStr, fileName) {
        const blob = new Blob([svgStr], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            URL.revokeObjectURL(url);
            a.remove();
        }, 1000);
    }

    document.getElementById('btnPreview').addEventListener('click', async () => {
        openPreviewBusy();
        try {
            const {width, height, want, colors} = getSelections();
            const bbox = getActiveBBox();
            const elements = await fetchElementsForBBox(bbox, want);
            const {svgStr, fileName} = buildSVG({width, height, bbox, elements, want, colors});
            showPreviewSvg(svgStr, fileName);
        } catch (e) {
            previewBusy.innerHTML = `<div class="text-muted">Failed to generate SVG. ${e && e.message ? e.message : ''}</div>`;
        }
    });

    document.getElementById('btnExport').addEventListener('click', async () => {
        // Export: no preview; show page loader until vector builds, then download
        pageBusy.classList.remove('d-none');
        const btn = document.getElementById('btnExport');
        const oldHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Exporting…`;
        try {
            const {width, height, want, colors} = getSelections();
            const bbox = getActiveBBox();
            const elements = await fetchElementsForBBox(bbox, want);
            const {svgStr, fileName} = buildSVG({width, height, bbox, elements, want, colors});
            downloadSVG(svgStr, fileName);
        } catch (e) {
            alert(`Failed to generate SVG: ${e && e.message ? e.message : e}`);
        } finally {
            pageBusy.classList.add('d-none');
            btn.disabled = false;
            btn.innerHTML = oldHTML;
        }
    });
</script>
</body>
</html>
